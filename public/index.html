<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files - Epistery</title>
    <link rel="stylesheet" href="/style/static.css">
    <style>
        .breadcrumb {
            padding: var(--spacer);
            color: var(--text-color-quiet);
            font-size: 0.9rem;
            border-bottom: 1px solid var(--page-border);
        }
        .breadcrumb a {
            color: var(--action-color);
            text-decoration: none;
        }
        .breadcrumb a:hover {
            text-decoration: underline;
        }
        .breadcrumb-separator {
            margin: 0 0.5em;
            color: var(--text-color-quiet);
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--spacer2);
            padding: var(--spacer2);
            min-height: 400px;
        }

        .file-tile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacer);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            border: 2px solid transparent;
        }
        .file-tile:hover {
            background: var(--bg-color-quiet-d);
        }
        .file-tile.selected {
            background: var(--bg-color-quiet-d);
            border-color: var(--action-color);
        }

        .file-tile-icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: var(--spacerhalf);
        }

        .file-tile-name {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-color);
            word-break: break-word;
            width: 100%;
        }

        .folder-tile-icon {
            color: var(--action-color);
        }

        .sidebar-section {
            margin-bottom: var(--spacer2);
        }

        .sidebar-section h3 {
            font-size: 0.9rem;
            color: var(--text-color-quiet);
            margin-bottom: var(--spacer);
        }

        .sidebar-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--spacerhalf);
        }

        .detail-item {
            margin-bottom: var(--spacerhalf);
            font-size: 0.85rem;
        }

        .detail-label {
            color: var(--text-color-quiet);
            font-weight: 600;
        }

        .detail-value {
            color: var(--text-color);
            word-break: break-all;
        }

        .drop-active {
            background: var(--bg-color-quiet-d);
            outline: 2px dashed var(--action-color);
            outline-offset: -10px;
        }

        input[type="file"] {
            display: none;
        }

        .request-access-widget {
            margin-bottom: var(--spacer);
        }

        #folder-tree {
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .tree-item {
            padding: var(--spacerhalf) 0;
            cursor: pointer;
            transition: color 0.2s;
            user-select: none;
        }

        .tree-item:hover {
            color: var(--action-color);
        }

        .tree-item.active {
            color: var(--action-color);
            font-weight: 600;
        }

        .tree-folder {
            margin-left: var(--spacer);
        }

        .tree-folder-name {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tree-folder-icon {
            font-size: 0.9rem;
        }
    </style>
    <script src="/script/common.js"></script>
</head>
<body>
    <header>
        <nav>
            <a href="/?home" class="logo">
                <img alt="logo" src="/image/epistery-logo-32.svg" class="logo-window">
            </a>
        </nav>
    </header>

    <main class="console-layout">
        <div class="console-main" id="drop-zone">
            <div class="breadcrumb" id="breadcrumb">
                <a href="#" onclick="navigateToFolder(''); return false;" id="domain-crumb">localhost</a>
            </div>

            <div class="file-grid" id="file-grid">
                <p style="text-align: center; color: var(--text-color-quiet); grid-column: 1 / -1;">No files or folders</p>
            </div>
        </div>

        <aside class="console-sidebar">
            <div class="request-access-widget" data-widget="requestAccess" data-agent="@epistery/files" data-list="files::upload"></div>

            <div class="sidebar-section" id="explorer-section">
                <h3>File Explorer</h3>
                <div id="folder-tree"></div>
            </div>

            <div class="sidebar-section">
                <h3>Actions</h3>
                <div class="sidebar-buttons">
                    <button class="console-btn" onclick="createFile()">üìÑ Create File</button>
                    <button class="console-btn" onclick="createFolder()">üìÅ Create Folder</button>
                    <button class="console-btn" onclick="uploadFiles()">‚¨ÜÔ∏è Upload Files</button>
                </div>
                <input type="file" id="file-input" multiple>
            </div>

            <div class="sidebar-section" id="details-section" style="display: none;">
                <h3>Details</h3>
                <div id="file-details"></div>
            </div>
        </aside>
    </main>

    <script type="module" src="/script/widgets.mjs"></script>
    <script type="module">
        // Load navigation
        fetch('/api/nav-menu')
            .then(r => r.text())
            .then(html => document.getElementById('nav-menu').innerHTML = html);

        const fileInput = document.getElementById('file-input');
        const fileGrid = document.getElementById('file-grid');
        const dropZone = document.getElementById('drop-zone');
        const detailsSection = document.getElementById('details-section');
        const fileDetails = document.getElementById('file-details');
        const domainCrumb = document.getElementById('domain-crumb');
        const folderTree = document.getElementById('folder-tree');

        let currentFolder = '';
        let selectedItem = null;
        let allFolders = new Set(); // Track all discovered folders for tree view

        // Set domain name
        domainCrumb.textContent = window.location.hostname || 'localhost';

        // Drag and drop on entire body panel
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drop-active');
        });

        dropZone.addEventListener('dragleave', (e) => {
            if (e.target === dropZone) {
                dropZone.classList.remove('drop-active');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drop-active');
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFileUpload(files);
            }
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(Array.from(e.target.files));
            }
        });

        // Upload files function (for button)
        window.uploadFiles = function() {
            fileInput.click();
        };

        // Create file function
        window.createFile = function() {
            const name = prompt('Enter file name:');
            if (!name) return;

            const content = prompt('Enter file content (optional):') || '';
            const blob = new Blob([content], { type: 'text/plain' });
            const file = new File([blob], name, { type: 'text/plain' });
            handleFileUpload([file]);
        };

        // Create folder function
        window.createFolder = async function() {
            const name = prompt('Enter folder name:');
            if (!name) return;

            // Validate folder name
            if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
                alert('Invalid folder name. Use only letters, numbers, hyphens, and underscores.');
                return;
            }

            try {
                const response = await fetch('/agent/epistery/files/api/folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        parentFolder: currentFolder
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to create folder');
                }

                const result = await response.json();
                console.log('Folder created:', result);
                loadFiles(currentFolder); // Reload current view
            } catch (error) {
                console.error('Create folder error:', error);
                alert('Failed to create folder: ' + error.message);
            }
        };

        // Navigate to folder
        window.navigateToFolder = function(folder) {
            loadFiles(folder);
        };

        // Upload files
        async function handleFileUpload(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', currentFolder);

                try {
                    const response = await fetch('/agent/epistery/files/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Upload failed');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(`Failed to upload ${file.name}: ${error.message}`);
                }
            }

            fileInput.value = '';
            loadFiles(currentFolder);
        }

        // Load file list
        async function loadFiles(folder = '') {
            currentFolder = folder;
            selectedItem = null;
            detailsSection.style.display = 'none';

            // Update breadcrumb
            updateBreadcrumb(folder);

            try {
                const response = await fetch(`/agent/epistery/files/api/list?folder=${encodeURIComponent(folder)}`);
                const data = await response.json();

                if (data.files.length === 0 && data.folders.length === 0) {
                    fileGrid.innerHTML = '<p style="text-align: center; color: var(--text-color-quiet); grid-column: 1 / -1;">No files or folders</p>';
                    return;
                }

                let html = '';

                // Show folders first
                for (const folder of data.folders) {
                    html += `
                        <div class="file-tile" onclick="selectFolder('${escapeHtml(folder.name)}', '${escapeHtml(folder.path)}')">
                            <div class="file-tile-icon folder-tile-icon">üìÅ</div>
                            <div class="file-tile-name">${escapeHtml(folder.name)}</div>
                        </div>
                    `;
                }

                // Show files
                for (const file of data.files) {
                    const ext = file.name.split('.').pop()?.toUpperCase().substring(0, 3) || 'FILE';
                    html += `
                        <div class="file-tile" onclick='selectFile(${JSON.stringify(file)})'>
                            <div class="file-tile-icon">üìÑ</div>
                            <div class="file-tile-name">${escapeHtml(file.name)}</div>
                        </div>
                    `;
                }

                fileGrid.innerHTML = html;

                // Update folder tree with discovered folders
                data.folders.forEach(f => allFolders.add(f.path));
                updateFolderTree();
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }

        // Update folder tree
        function updateFolderTree() {
            if (!folderTree) return;

            // Build tree structure
            const tree = buildFolderTree(Array.from(allFolders));
            const domain = window.location.hostname || 'localhost';

            let html = `
                <div class="tree-item ${currentFolder === '' ? 'active' : ''}" onclick="navigateToFolder(''); return false;">
                    <div class="tree-folder-name">
                        <span class="tree-folder-icon">üìÅ</span>
                        <span>${escapeHtml(domain)}</span>
                    </div>
                </div>
            `;

            html += renderTreeNode(tree, '');
            folderTree.innerHTML = html;
        }

        // Build folder tree structure
        function buildFolderTree(folders) {
            const tree = {};

            for (const folderPath of folders) {
                const parts = folderPath.split('/').filter(p => p);
                let current = tree;

                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    if (!current[part]) {
                        current[part] = {};
                    }
                    current = current[part];
                }
            }

            return tree;
        }

        // Render tree node recursively
        function renderTreeNode(node, parentPath) {
            let html = '';
            const entries = Object.keys(node).sort();

            for (const name of entries) {
                const path = parentPath ? `${parentPath}/${name}` : name;
                const isActive = currentFolder === path;

                html += `
                    <div class="tree-folder">
                        <div class="tree-item ${isActive ? 'active' : ''}" onclick="navigateToFolder('${escapeHtml(path)}'); return false;">
                            <div class="tree-folder-name">
                                <span class="tree-folder-icon">üìÅ</span>
                                <span>${escapeHtml(name)}</span>
                            </div>
                        </div>
                        ${renderTreeNode(node[name], path)}
                    </div>
                `;
            }

            return html;
        }

        // Update breadcrumb
        function updateBreadcrumb(folder) {
            const breadcrumb = document.getElementById('breadcrumb');
            const domain = window.location.hostname || 'localhost';

            let html = `<a href="#" onclick="navigateToFolder(''); return false;">${domain}</a>`;

            if (folder) {
                const parts = folder.split('/').filter(p => p);
                let path = '';
                for (const part of parts) {
                    path += (path ? '/' : '') + part;
                    html += `<span class="breadcrumb-separator">‚Ä∫</span><a href="#" onclick="navigateToFolder('${escapeHtml(path)}'); return false;">${escapeHtml(part)}</a>`;
                }
            }

            breadcrumb.innerHTML = html;
        }

        // Select folder
        window.selectFolder = function(name, path) {
            if (event && event.detail === 2) {
                // Double click - navigate
                loadFiles(path);
            } else {
                // Single click - select and show details
                document.querySelectorAll('.file-tile').forEach(t => t.classList.remove('selected'));
                event.currentTarget.classList.add('selected');

                selectedItem = { type: 'folder', name, path };
                showDetails();
            }
        };

        // Select file
        window.selectFile = function(file) {
            if (event && event.detail === 2) {
                // Double click - download
                downloadFile(file.id);
            } else {
                // Single click - select and show details
                document.querySelectorAll('.file-tile').forEach(t => t.classList.remove('selected'));
                event.currentTarget.classList.add('selected');

                selectedItem = { type: 'file', ...file };
                showDetails();
            }
        };

        // Show details in sidebar
        function showDetails() {
            if (!selectedItem) return;

            detailsSection.style.display = 'block';

            if (selectedItem.type === 'folder') {
                fileDetails.innerHTML = `
                    <div class="detail-item">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">Folder</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${escapeHtml(selectedItem.name)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Path</div>
                        <div class="detail-value">${escapeHtml(selectedItem.path)}</div>
                    </div>
                    <div style="margin-top: var(--spacer); display: flex; flex-direction: column; gap: var(--spacerhalf);">
                        <button class="console-btn small danger" onclick="deleteFolder('${escapeHtml(selectedItem.path)}')">Delete Folder</button>
                    </div>
                `;
            } else {
                fileDetails.innerHTML = `
                    <div class="detail-item">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">File</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Name</div>
                        <div class="detail-value">${escapeHtml(selectedItem.name)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Size</div>
                        <div class="detail-value">${formatSize(selectedItem.size)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Type</div>
                        <div class="detail-value">${escapeHtml(selectedItem.mimetype)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">IPFS Hash</div>
                        <div class="detail-value" style="font-size: 0.75rem;">${escapeHtml(selectedItem.ipfsHash)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Uploaded</div>
                        <div class="detail-value">${new Date(selectedItem.uploadedAt).toLocaleString()}</div>
                    </div>
                    <div style="margin-top: var(--spacer); display: flex; flex-direction: column; gap: var(--spacerhalf);">
                        <button class="console-btn small" onclick="downloadFile('${selectedItem.id}')">Download</button>
                        <button class="console-btn small danger" onclick="deleteFile('${selectedItem.id}')">Delete</button>
                    </div>
                `;
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        window.downloadFile = function(id) {
            window.location.href = `/agent/epistery/files/api/file/${id}/download`;
        };

        window.deleteFile = async function(id) {
            if (!confirm('Delete this file?')) return;

            try {
                const response = await fetch(`/agent/epistery/files/api/file/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Delete failed');
                }

                loadFiles(currentFolder);
            } catch (error) {
                console.error('Delete error:', error);
                alert('Failed to delete file: ' + error.message);
            }
        };

        window.deleteFolder = async function(path) {
            if (!confirm(`Delete folder "${path}"? This will fail if the folder is not empty.`)) return;

            try {
                const response = await fetch(`/agent/epistery/files/api/folder?path=${encodeURIComponent(path)}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Delete failed');
                }

                // Navigate to parent folder
                const parentPath = path.split('/').slice(0, -1).join('/');
                loadFiles(parentPath);
            } catch (error) {
                console.error('Delete folder error:', error);
                alert('Failed to delete folder: ' + error.message);
            }
        };

        // Load files on page load
        loadFiles();
    </script>
</body>
</html>
